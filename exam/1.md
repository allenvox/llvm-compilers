### Архитектура Clang

Clang — это front-end часть компилятора LLVM, который отвечает за разбор исходного кода на высокоуровневых языках программирования (например, C, C++, Objective-C) и генерацию промежуточного представления LLVM IR. Он состоит из нескольких ключевых компонентов, которые обрабатывают исходный код и формируют внутренние структуры для дальнейшей трансляции и оптимизации.

---

### Ключевые этапы работы Clang

1. **Лексический анализ (Lexical Analysis):**
   - Преобразует исходный текст программы в последовательность токенов (лексем), таких как ключевые слова, идентификаторы, операторы и литералы.
   - Компонент: `Lexer` (класс `clang::Lexer`).

2. **Синтаксический анализ (Parsing):**
   - Строит дерево разбора (Parse Tree) из токенов на основе грамматики языка.
   - Компонент: `Parser` (класс `clang::Parser`).
   - Результат: дерево синтаксического разбора (Abstract Syntax Tree, AST).

3. **Семантический анализ (Semantic Analysis):**
   - Проверяет, соответствует ли код правилам языка, включая:
     - Типы данных.
     - Совместимость операций.
     - Правильность вызовов функций.
   - Обогащает AST информацией о типах, символах и области видимости.
   - Компонент: `Sema` (класс `clang::Sema`) (да, это реально так).

4. **Генерация LLVM IR (Code Generation):**
   - Преобразует AST в LLVM IR, который является платформонезависимым промежуточным представлением.
   - Компонент: `CodeGen` (класс `clang::CodeGen`).
   - Использует `llvm::IRBuilder` для создания инструкций LLVM IR.

---

### Основные компоненты Clang

#### 1. **FrontendAction**
   - Определяет, какую задачу выполнять при компиляции, например:
     - Генерация LLVM IR.
     - Сбор метаданных (DWARF).
     - Генерация машинного кода.
   - Пример: `EmitLLVMOnlyAction`, `EmitObjAction`.

#### 2. **AST (Abstract Syntax Tree)**
   - Представляет синтаксическое дерево программы.
   - Каждый узел AST является экземпляром класса, например:
     - `clang::Decl` — декларации (переменные, функции).
     - `clang::Stmt` — инструкции (стейтменты) (условия, циклы).
     - `clang::Expr` — выражения (арифметические операции, вызовы функций).

#### 3. **Preprocessor (Препроцессор)**
   - Обрабатывает директивы препроцессора (`#include`, `#define`, `#ifdef`).
   - Удаляет макросы, вставляет заголовочные файлы, генерирует конечный поток токенов для лексера.

#### 4. **CodeGen**
   - Преобразует готовый AST в LLVM IR.
   - Компоненты:
     - `CodeGenModule` — отвечает за глобальные переменные и функции.
     - `CodeGenFunction` — отвечает за преобразование функций в IR.
     - Использует `llvm::IRBuilder` для генерации инструкций.

---

### Пример работы Clang

#### Исходный код на C:
```c
int sum(int a, int b) {
    return a + b;
}
```

#### Процесс обработки в Clang:

1. **Лексический анализ:**
   Исходный код преобразуется в токены:
   ```
   int, sum, (, int, a, ,, int, b, ), {, return, a, +, b, ;, }
   ```

2. **Синтаксический анализ:**
   На основе токенов строится AST:
   ```
   FunctionDecl 'sum'
       ParmVarDecl 'a' 'int'
       ParmVarDecl 'b' 'int'
       CompoundStmt
           ReturnStmt
               BinaryOperator '+'
                   DeclRefExpr 'a'
                   DeclRefExpr 'b'
   ```

3. **Семантический анализ:**
   Проверяется:
   - Совместимость типов параметров `a` и `b`.
   - Корректность операции `a + b` для типа `int`.
   - Правильность возврата значения.

4. **Генерация LLVM IR:**
   AST преобразуется в LLVM IR:
   ```llvm
   define i32 @sum(i32 %a, i32 %b) {
   entry:
       %0 = add i32 %a, %b
       ret i32 %0
   }
   ```

---

### Как Clang взаимодействует с LLVM

1. **Генерация IR:**
   - Используется компонент `CodeGen` для создания инструкций LLVM IR.
   - Пример:
     - `CodeGenFunction::EmitReturnStmt` вызывает IRBuilder для генерации инструкции `ret`.

2. **Передача IR в LLVM:**
   - Сгенерированный IR передается в менеджер проходов LLVM для оптимизации.
   - Пример: `opt` применяет оптимизационные проходы, такие как `mem2reg` или `loop-unroll`.

3. **Генерация машинного кода:**
   - После оптимизации IR передается в бэкенд LLVM для генерации объектного файла.

---

### Инструменты Clang

#### 1. **Clang Driver**
   - Командный интерфейс (`clang`), который автоматически связывает все этапы:
     - Препроцессинг.
     - Лексический и синтаксический анализ.
     - Генерация IR и машинного кода.
   - Пример команды:
     ```bash
     clang -S -emit-llvm test.c -o test.ll
     ```

#### 2. **LibTooling**
   - Библиотека для разработки инструментов на базе Clang, таких как анализаторы и рефакторинг-код.
   - Используется для создания статических анализаторов и инспекторов.
